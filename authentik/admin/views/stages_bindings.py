"""authentik StageBinding administration"""
from typing import Any

from django.contrib.auth.mixins import LoginRequiredMixin
from django.contrib.auth.mixins import (
    PermissionRequiredMixin as DjangoPermissionRequiredMixin,
)
from django.contrib.messages.views import SuccessMessageMixin
from django.db.models import Max
from django.urls import reverse_lazy
from django.utils.translation import gettext as _
from django.views.generic import ListView, UpdateView
from guardian.mixins import PermissionListMixin, PermissionRequiredMixin

from authentik.admin.views.utils import (
    BackSuccessUrlMixin,
    DeleteMessageView,
    UserPaginateListMixin,
)
from authentik.flows.forms import FlowStageBindingForm
from authentik.flows.models import Flow, FlowStageBinding
from authentik.lib.views import CreateAssignPermView


class StageBindingListView(
    LoginRequiredMixin, PermissionListMixin, UserPaginateListMixin, ListView
):
    """Show list of all flows"""

    model = FlowStageBinding
    permission_required = "authentik_flows.view_flowstagebinding"
    ordering = ["target", "order"]
    template_name = "administration/stage_binding/list.html"


class StageBindingCreateView(
    SuccessMessageMixin,
    BackSuccessUrlMixin,
    LoginRequiredMixin,
    DjangoPermissionRequiredMixin,
    CreateAssignPermView,
):
    """Create new StageBinding"""

    model = FlowStageBinding
    permission_required = "authentik_flows.add_flowstagebinding"
    form_class = FlowStageBindingForm

    template_name = "generic/create.html"
    success_url = reverse_lazy("authentik_admin:stage-bindings")
    success_message = _("Successfully created StageBinding")

    def get_initial(self) -> dict[str, Any]:
        if "target" in self.request.GET:
            initial_target_pk = self.request.GET["target"]
            targets = Flow.objects.filter(pk=initial_target_pk).select_subclasses()
            if not targets.exists():
                return {}
            max_order = FlowStageBinding.objects.filter(
                target=targets.first()
            ).aggregate(Max("order"))["order__max"]
            if not isinstance(max_order, int):
                max_order = -1
            return {"target": targets.first(), "order": max_order + 1}
        return super().get_initial()


class StageBindingUpdateView(
    SuccessMessageMixin,
    BackSuccessUrlMixin,
    LoginRequiredMixin,
    PermissionRequiredMixin,
    UpdateView,
):
    """Update FlowStageBinding"""

    model = FlowStageBinding
    permission_required = "authentik_flows.change_flowstagebinding"
    form_class = FlowStageBindingForm

    template_name = "generic/update.html"
    success_url = reverse_lazy("authentik_admin:stage-bindings")
    success_message = _("Successfully updated StageBinding")


class StageBindingDeleteView(
    LoginRequiredMixin, PermissionRequiredMixin, DeleteMessageView
):
    """Delete FlowStageBinding"""

    model = FlowStageBinding
    permission_required = "authentik_flows.delete_flowstagebinding"

    template_name = "generic/delete.html"
    success_url = reverse_lazy("authentik_admin:stage-bindings")
    success_message = _("Successfully deleted FlowStageBinding")
