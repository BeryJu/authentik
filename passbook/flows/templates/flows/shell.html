{% extends 'base/skeleton.html' %}

{% load static %}
{% load i18n %}

{% block head %}
{{ block.super }}
<style>
    .pb-loading,
    .pf-c-login__main >iframe {
        display: flex;
        height: 100%;
        width: 100%;
        justify-content: center;
        align-items: center;
    }
    .pb-hidden {
        display: none
    }
</style>
{% endblock %}

{% block body %}
<div class="pf-c-background-image">
    <svg xmlns="http://www.w3.org/2000/svg" class="pf-c-background-image__filter" width="0" height="0">
        <filter id="image_overlay">
            <feColorMatrix type="matrix" values="1 0 0 0 0 1 0 0 0 0 1 0 0 0 0 0 0 0 1 0"></feColorMatrix>
            <feComponentTransfer color-interpolation-filters="sRGB" result="duotone">
                <feFuncR type="table" tableValues="0.086274509803922 0.43921568627451"></feFuncR>
                <feFuncG type="table" tableValues="0.086274509803922 0.43921568627451"></feFuncG>
                <feFuncB type="table" tableValues="0.086274509803922 0.43921568627451"></feFuncB>
                <feFuncA type="table" tableValues="0 1"></feFuncA>
            </feComponentTransfer>
        </filter>
    </svg>
</div>
{# TODO: Load messages dynamically via API #}
{% include 'partials/messages.html' %}
<div class="pf-c-login">
    <div class="pf-c-login__container">
        <header class="pf-c-login__header">
            <img class="pf-c-brand" src="{% static 'passbook/logo.svg' %}" style="height: 60px;"
                alt="passbook icon" />
            <img class="pf-c-brand" src="{% static 'passbook/brand.svg' %}" style="height: 60px;"
                alt="passbook branding" />
        </header>
        <main class="pf-c-login__main" id="flow-body">
            <div class="pf-c-login__main-body pb-loading">
                <span class="pf-c-spinner" role="progressbar" aria-valuetext="Loading...">
                    <span class="pf-c-spinner__clipper"></span>
                    <span class="pf-c-spinner__lead-ball"></span>
                    <span class="pf-c-spinner__tail-ball"></span>
                </span>
            </div>
        </main>
        <footer class="pf-c-login__footer">
            <p></p>
            <ul class="pf-c-list pf-m-inline">
                <li>
                    <a href="https://beryju.github.io/passbook/">{% trans 'Documentation' %}</a>
                </li>
                <!-- todo: load config.passbook.footer.links -->
            </ul>
        </footer>
    </div>
</div>
<script>
const flowBodyUrl = "{{ exec_url }}";
const flowBody = document.querySelector("#flow-body");
const spinner = document.querySelector(".pb-loading");

const updateCard = (response) => {
    if (!response.ok) {
        console.log("well");
    }
    if (response.redirected && !response.url.endsWith(flowBodyUrl)) {
        window.location = response.url;
    } else {
        response.text().then(text => {
            flowBody.innerHTML = text;
            loadFormCode();
            setFormSubmitHandlers();
        });
    }
};
const showSpinner = () => {
    flowBody.innerHTML = "";
    flowBody.appendChild(spinner);
};
const loadFormCode = () => {
    document.querySelectorAll("#flow-body script").forEach(script => {
        let newScript = document.createElement("script");
        newScript.src = script.src;
        document.head.appendChild(newScript);
    });
}
const setFormSubmitHandlers = () => {
    document.querySelectorAll("#flow-body form").forEach(form => {
        console.log(`Setting action for form ${form}`);
        // debugger;
        form.action = flowBodyUrl;
        console.log(`Adding handler for form ${form}`);
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            let formData = new FormData(form);
            fetch(flowBodyUrl, {
                method: 'post',
                body: formData,
            }).then((response) => {
                showSpinner();
                if (!response.url.endsWith(flowBodyUrl)) {
                    window.location = response.url;
                } else {
                    updateCard(response);
                }
            });
        });
    });
};

fetch(flowBodyUrl).then(updateCard);

</script>
{% endblock %}
